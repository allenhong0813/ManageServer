@*
    For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Permission";

}

<h2><b>權限管理</b></h2>

<!-- Content here -->

<form class="form-inline">
    <div class="form-group form-pairs">
        <label class="text-right">使用者ID</label>
        <input id="inpUserID" type="text" class="form-control" placeholder="UserID" style="margin-bottom: 5px;">
    </div>
    <div class="form-group  form-pairs" style="padding-bottom:5px">
        <label class="text-right">是否是管理者</label>
        <select id="selIsAdmin" class="form-control">
            <option value="">全選</option>
            <option value="true">是</option>
            <option value="false">否</option>
        </select>
    </div>
    <button type="button" class="btn btn-sm btn-primary" style="margin-bottom: 5px;" onclick="query()">查詢</button>

</form>


<div id="jsGrid"></div>

@*dialog page*@
<div id="dialog-form" title="授權設定" style="display:none">
    @*<p class="validateTips">All form fields are required.</p>*@
    <div id="pmjsGrid"></div>
</div>

<script>
    var dialog;
    var form;
    var machineList = @Json.Serialize(ViewData["MachineList"]);
    var userMachineData = null;
    var active;
    var onRowUserID;

    $(document).ready(function () {
        initGrid();
        getGridData();
        initDetailGrid();
    });

    function initGrid(){
        $("#jsGrid").jsGrid({
            width: "100%",
            height: "400px",
            filtering: false,
            editing: true,
            selecting: true,
            inserting: false,
            sorting: true,
            paging: false,
            rowClick: function () { return; },
            autoload: false,
            invalidMessage: "欄位輸入有誤：",

            controller: {
                loadData: function (filter) {
                    return filter;
                },
                updateItem: function (updatingItem) {
                    var d = $.Deferred();
                    $.ajax({
                        type: "PUT",
                        url: "/Permission/UpdateUserMachineData",
                        data: {
                            isAdmin:item.isAdmin,
                            userID:item.userID,
                            machineKeys:item.assignMachineKeys
                        }
                    }).done(function (result) {
                        if (result == "success")
                            d.resolve(updatingItem);
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.responseText == "Update Error.") {
                            alert("Update error：取得資料發生錯誤。");
                        }else {
                            alert("發生錯誤。");
                            console.error(jqXHR.responseText);
                        }
                    });
                    return d.promise();
                },
            },

            fields: [
                {
                    name: "userID", type: "text", title: "*使用者ID", width: 100,
                    editTemplate: function(value) {
                        var $editControl = jsGrid.fields.text.prototype.editTemplate.call(this, value);
                        return $("<div>").attr("title", (value === undefined || value === null) ? "" : value).text((value === undefined || value === null) ? "" : value);
                    }
                },
                {
                    name: "isAdmin", type: "", title: "*是否是管理者", width: 50,
                    itemTemplate: function (value, item) {
                        return chkDisableAdmin(value, item);
                    },
                    editTemplate: function(value , item) {
                        return chkIsAdmin(value, item);
                    },
                },
                {
                    name: "assignMachineKeys", type: "", title: "授權機台", width: 100,
                    itemTemplate: function (machineValue, userItem) {
                        return btnPermission('item',machineValue, userItem);
                    },
                    editTemplate: function (machineValue, userItem) {
                        return btnPermission('edit',machineValue, userItem);
                    },
                },
                {
                    type: "control", deleteButton: false
                }
            ]
        });
    }

    function getGridData() {
        var d = $.Deferred();
        $.ajax({
            type: "GET",
            url: '/Permission/GetGridData'
        }).done(function (data) {
            userMachineData = data;
            $("#jsGrid").jsGrid("loadData", userMachineData);
            d.resolve(data);
        }).fail(function (jqXHR, textStatus, errorThrown) {
            if (jqXHR.responseText == "GetAdminInfo Error.") {
                alert(alert("Inital error：資料庫伺服器發生錯誤，無法取得資料。"));
            }
            else if (jqXHR.responseText == "DBNoConnect") {
                alert("Inital error：未連接上資料庫。")
            }
            else {
                alert("發生錯誤。");
                console.error(jqXHR.responseText);
            }
        });
        return d.promise();
    }

    function initDetailGrid(){
        $("#pmjsGrid").jsGrid({
            width: "100%",
            height: "100%",
            filtering: false,
            editing: false,
            selecting: true,
            inserting: false,
            sorting: false,
            paging: false,
            autoload: false,
            data: machineList,
            invalidMessage: "勾選有誤：",
            controller: {
                loadData: function (filter) {
                    return filter;
                },
            },
            fields: [
                {
                    headerTemplate: function() {
                        return $("<input>全選</input>").attr("type", "checkbox").attr("id","inpCheckAll").attr("name","inpCheckAll")
                                .on("click", function () {
                                    checkedAllItem(userItem, machineList);
                                });
                    },
                    itemTemplate: function(machineValue, machineItem) {
                        return $("<input>").attr("type", "checkbox").attr("name","inpCheckItem")
                                .prop("checked", machineItem.isApply)
                                .on("change", function () {
                                    $(this).is(":checked") ? checkedSingleItem(userItem, machineItem, machineList):uncheckedSingleItem(userItem, machineItem, machineList);
                                    checkOrRemoveCheckAll();
                                });
                    },
                    align: "center",
                    width: 50
                },
                {
                    name: "ip", type: "text", title: "IP", width: 80,
                },
                {
                    name: "name", type: "text", title: "伺服器名稱", width: 80,
                },
                {
                    name: "os", type: "text", title: "作業系統", width: 80,
                },
                {
                    name: "description", type: "text", title: "描述", width: 80,
                }
            ]
        })
    }

    function btnPermission(action,machineValue, UserItem) {
        var $btnPermissionSetting;
        if(action=="item"){
            $btnPermissionSetting = $("<button class='btn btn-default btnPermission'>").prop('disabled', true).text("授權設定");
        }else if (action == "edit"){
            $btnPermissionSetting = $("<button class='btn btn-default btnPermission'>").prop('disabled', UserItem.isAdmin).text("授權設定");
        }
        $btnPermissionSetting.on("click", function () {
            dialogForm(active, machineValue, UserItem, confirmFunction);
            getUserMachine(machineValue, UserItem);
            setUserPermission(machineValue, UserItem);
           // $("#pmjsGrid").jsGrid("loadData", machineList);
            checkOrRemoveCheckAll();
        });
        return $btnPermissionSetting;
    }

    //checkbox function
    function chkDisableAdmin(isAdminValue, isAdminItem) {
        var $chkIsAdmin = $("<input disabled>").attr("type", "checkbox");
        return $chkIsAdmin.prop("checked", isAdminValue);
    }

    function chkIsAdmin(isAdminValue, isAdminItem) {
        var $chkIsAdmin = $("<input >").attr("type", "checkbox");
        return $chkIsAdmin.prop("checked", isAdminValue)
                            .on("change", function (event) {
                                var isChecked = $(this).is(":checked");
                                chkAdminItem(isChecked,isAdminItem);
                            });
    }

    function chkAdminItem(isChecked,isAdminItem){
        isAdminItem.isAdmin=isChecked;
        $(".jsgrid-edit-row > .jsgrid-cell >.btnPermission").prop('disabled', isChecked);
    }

    function getUserMachine(machineValue,userItem){
        var assignMachineKeys = item.assignMachineKeys;
        $.each(machineList, function (index, machine) {
            if(assignMachineKeys.indexOf(machine.key) > -1){
                machine.isApply = true;
            }else{
                machine.isApply = false;
            }
        });
    }

    //dialog confirm button
    var confirmFunction = function(action) {
        var currentUserMachine = $.grep(userMachineData, function (element, index) {
            return element.userID == onRowUserID;
        });

        currentUserMachine[0].assignMachineKeys = [];

        $.each(machineList, function (indexInArray, machine) {
            if(machine.isApply == true)
                currentUserMachine[0].assignMachineKeys.push(machine.key);
        });

        $.each(userMachineData, function (indexInArray, userMachine) {
            if(userMachine.userID == currentUserMachine[0].userID){
                userMachine.assignMachineKeys = currentUserMachine[0].assignMachineKeys;
            }
        });

        dialog.dialog("close");
    }

    var checkedSingleItem = function(userItem,machineItem,machineList) {
        machineItem.isApply = true;
        onRowUserID = userItem.userID;
    };

    var uncheckedSingleItem = function(userItem,machineItem,machineList) {
        machineItem.isApply = false;
        onRowUserID = userItem.userID;
    };

    var checkedAllItem = function(userItem,machineList) {
        if($("#inpCheckAll").prop("checked")) {
            $("input[name='inpCheckItem']").prop("checked", true);
            $.each(machineList, function (index, machine) {
                machine.isApply = true;
            });
        }else{
            $("input[name='inpCheckItem']").prop("checked", false);
            $.each(machineList, function (index, machine) {
                machine.isApply = false;
            });
        }
    };

    //button query function
    function query() {
        var inpUserID = "";
        var selIsAdmin = "";

        if ($("#inpUserID").val() != null && $("#inpUserID").val() != "")
            inpUserID = $("#inpUserID").val();

        selIsAdmin = $("#selIsAdmin option:selected").val();
        if (selIsAdmin != null && selIsAdmin != "")
            selIsAdmin = selIsAdmin;

        $.ajax({
            type: "GET",
            url: "/Permission/GetAdminInfo",
            data: {
                userID: inpUserID,
                isAdmin: selIsAdmin
            }
        }).done(function (data) {
            userMachineData = data;
            $("#jsGrid").jsGrid("loadData", userMachineData);

        }).fail(function (jqXHR, textStatus, errorThrown) {
            if (jqXHR.responseText == "GetServerInfo Error.") {
                alert("Query error：取得資料發生錯誤。");
            }else {
                alert("發生錯誤。");
                console.error(jqXHR.responseText);
            }
        });
    }
</script>